systemd:
  units:
    - name: container-nfs-server.service
      enabled: false
      contents: |
        [Unit]
        Description=openSUSE NFS Server container
        Documentation=https://en.opensuse.org/Portal:Container/Image/nfs-server
        Documentation=man:podman-run(1)
        After=network-online.target local-fs.target firewalld.service
        Wants=network-online.target
        Requires=container-default-network.service
        After=container-default-network.service
        StartLimitIntervalSec=40
        StartLimitBurst=5
        RequiresMountsFor=%t/containers
        RequiresMountsFor=/
        RequiresMountsFor=/etc/exports
        RequiresMountsFor=/etc/exports.d
        RequiresMountsFor=/var/home
        RequiresMountsFor=/var/mnt/nfs-share

        [Service]
        Environment=PODMAN_SYSTEMD_UNIT=%n
        Restart=on-failure
        RestartSec=1s
        TimeoutStartSec=70
        ExecStartPre=-/usr/bin/podman pull ${NFS_SERVER_IMAGE_PATH}
        ExecStart=/usr/bin/podman run --name nfs-server  -d --rm \
                      --cidfile=%t/%N.cid --replace --log-driver journald --cgroups=split \
                      --network=systemd-default --sdnotify=conmon --privileged \
                      --label io.containers.autoupdate=registry --publish 2049:2049 \
                      --mount type=bind,src=/etc/exports,dst=/etc/exports,ro=true \
                      --mount type=bind,src=/etc/exports.d,dst=/etc/exports.d,ro=true \
                      --mount type=bind,src=/var/home,dst=/home \
                      --mount type=bind,src=/var/mnt/nfs-share,dst=/mnt/nfs-share \
                    registry.opensuse.org/opensuse/nfs-server:latest
        ExecStop=/usr/bin/podman stop --ignore --cidfile=%t/%N.cid -t 10
        ExecStopPost=/usr/bin/podman rm --ignore -f --cidfile=%t/%N.cid
        SyslogIdentifier=%N
        KillMode=mixed
        Delegate=yes
        Type=notify
        NotifyAccess=all

        [Install]
        WantedBy=multi-user.target

storage:
  directories:
    - path: /var/mnt/nfs-share
      mode: 0755
  files:
    - path: /etc/modules-load.d/nfs.conf
      mode: 0660
      contents:
        inline: nfsd
    - path: /etc/exports
      mode: 0644
      contents:
        inline: |
          /mnt/nfs-share *(rw,fsid=0,sync,no_subtree_check,no_root_squash)
